<!-- Observability Tab -->
<div id="observability" class="tab-content">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #observability.fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Control Plane Logs Styles */
        .control-plane-logs-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logs-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .logs-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .time-range-selector {
            display: flex;
            gap: 0.25rem;
        }
        
        .time-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .time-btn:hover {
            background: var(--bg-color);
            color: var(--text-primary);
        }
        
        .time-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .refresh-btn {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: var(--bg-color);
            color: var(--text-primary);
        }
        
        .logs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .log-metric-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            position: relative;
        }
        
        .log-metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .log-metric-header h5 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .log-metric-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .info-icon, .more-icon {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .info-icon:hover, .more-icon:hover {
            color: var(--text-primary);
        }
        
        .log-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .log-metric-chart {
            height: 120px;
            margin-bottom: 0.5rem;
        }
        
        .log-metric-legend {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        .logs-loading, .logs-error {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .logs-error {
            color: var(--status-failed);
        }
    </style>

    <!-- UPDATED: Skeleton loader for metrics charts -->
    <div id="metrics-loading-state" class="skeleton-wrapper" style="display: none;">
        <div class="metrics-grid-2col">
            {% for i in range(6) %}
            <div class="widget">
                <div class="widget-header" style="background: none; border: none; padding-bottom: 0;">
                    <div class="skeleton skeleton-text" style="width: 40%; height: 20px;"></div>
                </div>
                <div class="widget-content">
                    <div class="skeleton" style="width: 100%; height: 220px;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="metrics-error-state" style="display: none;" class="no-data-message">
        <p class="error-message">Could not load metrics data.</p>
    </div>

    <div class="metrics-container" style="display: none;">
        <h3 class="section-title">Cluster Health Summary</h3>
        <div class="metrics-grid-2col">
            <div class="widget"><div class="widget-header"><h2>Node Status</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeStatusChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Container Restarts (Sum)</h2></div><div class="widget-content chart-widget-content"><canvas id="containerRestartsChart"></canvas></div></div>
        </div>
        
        <h3 class="section-title">Nodes Status and Capacity</h3>
        <div class="metrics-grid-2col">
            <div class="widget"><div class="widget-header"><h2>Number of Ready Nodes</h2></div><div class="widget-content chart-widget-content"><canvas id="numReadyNodesChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Nodes Error Condition</h2></div><div class="widget-content chart-widget-content"><canvas id="nodesErrorConditionChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Running Pods per Node</h2></div><div class="widget-content chart-widget-content"><canvas id="runningPodsPerNodeChart"></canvas></div></div>
        </div>

        <h3 class="section-title">Node Performance</h3>
        <div class="metrics-grid-2col">
            <div class="widget"><div class="widget-header"><h2>Node CPU Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeCpuChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Node Memory Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeMemoryChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Node Network Total Bytes (Bytes/s)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeNetworkChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Node Filesystem Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeFsChart"></canvas></div></div>
        </div>

        <h3 class="section-title">Pod Performance and Limits</h3>
        <div class="metrics-grid-2col">
            <div class="widget"><div class="widget-header"><h2>Pod CPU Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podCpuChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Pod Memory Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podMemoryChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Pod CPU Utilization over Pod Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podCpuOverPodLimitChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Pod Memory Utilization over Pod Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podMemoryOverPodLimitChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Pod Status</h2></div><div class="widget-content chart-widget-content"><canvas id="podStatusChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>Pod Network (Bytes/s)</h2></div><div class="widget-content chart-widget-content"><canvas id="podNetworkChart"></canvas></div></div>
        </div>
        
        <h3 class="section-title">Control Plane</h3>
        <div class="metrics-grid-2col">
            <div class="widget"><div class="widget-header"><h2>API Server Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="apiServerRequestsChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>REST Client Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="restClientRequestsChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>API Server Admission / ETCD Duration</h2></div><div class="widget-content chart-widget-content"><canvas id="admissionEtcdDurationChart"></canvas></div></div>
            <div class="widget"><div class="widget-header"><h2>API Server Storage</h2></div><div class="widget-content chart-widget-content"><canvas id="apiServerStorageChart"></canvas></div></div>
        </div>
        
        <h3 class="section-title">Control Plane Logs</h3>
        <div class="control-plane-logs-container">
            <div class="logs-header">
                <h4>API Server Request Metrics</h4>
                <div class="logs-controls">
                    <div class="time-range-selector">
                        <button class="time-btn active" data-range="3h">3h</button>
                        <button class="time-btn" data-range="12h">12h</button>
                        <button class="time-btn" data-range="1d">1d</button>
                        <button class="time-btn" data-range="3d">3d</button>
                        <button class="time-btn" data-range="1w">1w</button>
                    </div>
                    <button class="refresh-btn" id="refreshControlPlaneLogs">
                        <i data-feather="refresh-cw"></i>
                    </button>
                </div>
            </div>
            
            <div class="logs-grid">
                <div class="log-metric-card">
                    <div class="log-metric-header">
                        <h5>Requests</h5>
                        <div class="log-metric-actions">
                            <i data-feather="info" class="info-icon"></i>
                            <i data-feather="more-vertical" class="more-icon"></i>
                        </div>
                    </div>
                    <div class="log-metric-value" id="requestsValue">-</div>
                    <div class="log-metric-chart">
                        <canvas id="requestsChart"></canvas>
                    </div>
                    <div class="log-metric-legend">apiserver_request_total</div>
                </div>
                
                <div class="log-metric-card">
                    <div class="log-metric-header">
                        <h5>Requests HTTP 4XX</h5>
                        <div class="log-metric-actions">
                            <i data-feather="info" class="info-icon"></i>
                            <i data-feather="more-vertical" class="more-icon"></i>
                        </div>
                    </div>
                    <div class="log-metric-value" id="requests4XXValue">-</div>
                    <div class="log-metric-chart">
                        <canvas id="requests4XXChart"></canvas>
                    </div>
                    <div class="log-metric-legend">apiserver_request_total_4XX</div>
                </div>
                
                <div class="log-metric-card">
                    <div class="log-metric-header">
                        <h5>Requests HTTP 5XX</h5>
                        <div class="log-metric-actions">
                            <i data-feather="info" class="info-icon"></i>
                            <i data-feather="more-vertical" class="more-icon"></i>
                        </div>
                    </div>
                    <div class="log-metric-value" id="requests5XXValue">-</div>
                    <div class="log-metric-chart">
                        <canvas id="requests5XXChart"></canvas>
                    </div>
                    <div class="log-metric-legend">apiserver_request_total_5XX</div>
                </div>
                
                <div class="log-metric-card">
                    <div class="log-metric-header">
                        <h5>Requests HTTP 429</h5>
                        <div class="log-metric-actions">
                            <i data-feather="info" class="info-icon"></i>
                            <i data-feather="more-vertical" class="more-icon"></i>
                        </div>
                    </div>
                    <div class="log-metric-value" id="requests429Value">-</div>
                    <div class="log-metric-chart">
                        <canvas id="requests429Chart"></canvas>
                    </div>
                    <div class="log-metric-legend">apiserver_request_total_429</div>
                </div>
                
                <div class="log-metric-card">
                    <div class="log-metric-header">
                        <h5>Storage Size Bytes</h5>
                        <div class="log-metric-actions">
                            <i data-feather="info" class="info-icon"></i>
                            <i data-feather="more-vertical" class="more-icon"></i>
                        </div>
                    </div>
                    <div class="log-metric-value" id="storageSizeValue">-</div>
                    <div class="log-metric-chart">
                        <canvas id="storageSizeChart"></canvas>
                    </div>
                    <div class="log-metric-legend">apiserver_storage_size_bytes</div>
                </div>
                
            </div>
            
            <div class="logs-loading" id="controlPlaneLogsLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Loading control plane logs...</p>
            </div>
            
            <div class="logs-error" id="controlPlaneLogsError" style="display: none;">
                <p>Failed to load control plane logs. Please try again.</p>
            </div>
        </div>
    </div>
</div>

<script>
    let controlPlaneLogsCharts = {};
    let currentTimeRange = '3h';
    
    window.addEventListener('load', () => {
        const tab = document.getElementById('observability');
        if (tab) {
            tab.classList.add('fade-in');
        }
        
        // Initialize control plane logs functionality
        initializeControlPlaneLogs();
    });
    
    function initializeControlPlaneLogs() {
        // Set up time range buttons
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentTimeRange = e.target.dataset.range;
                loadControlPlaneLogs();
            });
        });
        
        // Set up refresh button
        document.getElementById('refreshControlPlaneLogs').addEventListener('click', () => {
            loadControlPlaneLogs();
        });
        
        // Load initial data
        loadControlPlaneLogs();
    }
    
    async function loadControlPlaneLogs() {
        const loadingEl = document.getElementById('controlPlaneLogsLoading');
        const errorEl = document.getElementById('controlPlaneLogsError');
        const logsContainer = document.querySelector('.control-plane-logs-container');
        
        // Show loading state
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        logsContainer.style.display = 'none';
        
        try {
            const response = await fetch(`/api/control-plane-logs/{{ cluster.account_id }}/{{ cluster.region }}/{{ cluster.name }}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Hide loading, show data
            loadingEl.style.display = 'none';
            logsContainer.style.display = 'block';
            
            // Update charts
            updateControlPlaneLogsCharts(data);
            
        } catch (error) {
            console.error('Error loading control plane logs:', error);
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
        }
    }
    
    function updateControlPlaneLogsCharts(data) {
        // Update Requests chart
        updateLogChart('requestsChart', 'requestsValue', data.apiserver_request_total, 'Requests');
        
        // Update 4XX Requests chart
        updateLogChart('requests4XXChart', 'requests4XXValue', data.apiserver_request_total_4XX, '4XX Requests');
        
        // Update 5XX Requests chart
        updateLogChart('requests5XXChart', 'requests5XXValue', data.apiserver_request_total_5XX, '5XX Requests');
        
        // Update 429 Requests chart
        updateLogChart('requests429Chart', 'requests429Value', data.apiserver_request_total_429, '429 Requests');
        
        // Update Storage Size chart
        updateLogChart('storageSizeChart', 'storageSizeValue', data.apiserver_storage_size_bytes, 'Storage Size Bytes');
        
    }
    
    function updateLogChart(canvasId, valueId, metricData, title) {
        if (!metricData || !metricData.values || metricData.values.length === 0) {
            document.getElementById(valueId).textContent = '-';
            return;
        }
        
        // Update current value
        const currentValue = metricData.current_value || 0;
        document.getElementById(valueId).textContent = formatValue(currentValue);
        
        // Get or create chart
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        
        // Destroy existing chart if it exists
        if (controlPlaneLogsCharts[canvasId]) {
            controlPlaneLogsCharts[canvasId].destroy();
        }
        
        // Prepare data
        const timestamps = metricData.timestamps.map(ts => new Date(ts));
        const values = metricData.values;
        
        // Create new chart
        controlPlaneLogsCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: title,
                    data: values,
                    borderColor: '#0D6EFD',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxTicksLimit: 6
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatValue(value);
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }
    
    function formatValue(value) {
        if (value >= 1000000) {
            return (value / 1000000).toFixed(1) + 'M';
        } else if (value >= 1000) {
            return (value / 1000).toFixed(1) + 'k';
        } else if (value < 1 && value > 0) {
            return value.toFixed(3);
        } else {
            return Math.round(value).toString();
        }
    }
</script>
