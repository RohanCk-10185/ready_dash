<!-- Compute Tab -->
<div id="compute" class="tab-content">

    <!-- Styles for Node Group filter, count & animation -->
    <style>
    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--surface-color);
        border-top-left-radius: 8px;    
        border-top-right-radius: 8px;
    }

    .widget-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .resource-filters {
        display: flex;
        align-items: center;
    }

    .resource-filters select.form-select {
        padding: 8px 12px;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: var(--background-color);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s ease-in-out;
        min-width: 220px;
    }

    .resource-filters select.form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(60, 132, 244, 0.2);
    }

    .node-count-wrapper {
        font-weight: 500;
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-left: 8px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.2s ease-in-out;
    }
    </style>

    <!-- Nodes Section -->
    <div class="widget">
        <div class="widget-header">
            <h2>
                Nodes
                <span id="node-count-wrapper" class="node-count-wrapper" style="display: none;">
                    (<span id="node-count">0</span>)
                </span>
            </h2>
            <div class="resource-filters">
                <select id="nodegroup-filter" class="form-select">
                    <option value="all">All Node Groups</option>
                    {% for ng in cluster.nodegroups_data if not ng.is_karpenter_node %}
                    <option value="{{ ng.name }}">{{ ng.name }}</option>
                    {% endfor %}
                    <option value="karpenter">Karpenter/Auto-Mode</option>
                </select>
            </div>
        </div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table" id="nodes-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Instance Type</th>
                            <th>Node Group / Compute</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if cluster.workloads and 'nodes' in cluster.workloads and cluster.workloads['nodes'] %}
                            {% for node in cluster.workloads['nodes'] %}
                                {% set labels = node.metadata.labels or {} %}
                                {% set nodegroup_name = labels.get('eks.amazonaws.com/nodegroup') %}
                                {% set is_karpenter_or_auto = 'karpenter.sh/provisioner-name' in labels or labels.get('eks.amazonaws.com/compute-type') == 'ec2' %}
                                {% set data_nodegroup_value = nodegroup_name if nodegroup_name else 'karpenter' if is_karpenter_or_auto else 'other' %}
                                {% set compute_display_name = nodegroup_name if nodegroup_name else 'Karpenter/Auto-Mode' if is_karpenter_or_auto else 'EC2 (Self-managed)' %}
                                {% set node_status_obj = (node.status.conditions | selectattr('type', 'equalto', 'Ready') | list | first) %}
                                {% set node_status = 'Ready' if node_status_obj and node_status_obj.status == 'True' else 'NotReady' %}

                                <tr data-nodegroup="{{ data_nodegroup_value }}">
                                    <td>{{ node.metadata.name }}</td>
                                    <td><span class="status-badge status-{{ node_status.lower() }}">{{ node_status }}</span></td>
                                    <td>{{ labels.get('node.kubernetes.io/instance-type', 'N/A') }}</td>
                                    <td>{{ compute_display_name }}</td>
                                    <td>{{ node.metadata.creationTimestamp.split('T')[0] if node.metadata.creationTimestamp else 'N/A' }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-muted" style="text-align: center; padding: 2rem;">
                                    Node data not available. Workload fetching might be disabled or failed.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Node Groups Section -->
    <div class="widget">
        <div class="widget-header"><h2>Node Groups</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Desired Size</th>
                            <th>AMI Release Version</th>
                            <th>K8s Version</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set managed_ngs = cluster.nodegroups_data | selectattr('is_karpenter_node', 'equalto', false) | list %}
                        {% for ng in managed_ngs %}
                        <tr>
                            <td>{{ ng.name }}</td>
                            <td><span class="status-badge status-{{ ng.status.lower() if ng.status else 'unknown' }}">{{ ng.status }}</span></td>
                            <td>{{ ng.desired_size }}</td>
                            <td>{{ ng.release_version }}</td>
                            <td>{{ ng.version }}</td>
                            <td>
                                {% if not ng.is_karpenter_node and ng.version != cluster.version %}
                                <button class="action-btn upgrade-btn" data-nodegroup-name="{{ ng.name }}"><i data-feather="chevrons-up"></i> Upgrade Now</button>
                                {% else %}<span class="text-muted">Up to date</span>{% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-muted" style="text-align: center; padding: 2rem;">
                                No managed nodegroups found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fargate Profiles Section -->
    <div class="widget">
        <div class="widget-header"><h2>Fargate Profiles</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Name</th><th>Status</th></tr></thead>
                    <tbody>
                        {% for profile in cluster.fargate_profiles %}
                        <tr>
                            <td>{{ profile.name }}</td>
                            <td><span class="status-badge status-{{ profile.status.lower() if profile.status else 'unknown' }}">{{ profile.status or 'Active' }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-muted" style="text-align: center; padding: 2rem;">
                                No Fargate profiles found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS to control dynamic count and visibility -->
<script>
function updateNodeCount() {
    const filter = document.getElementById('nodegroup-filter');
    const countWrapper = document.getElementById('node-count-wrapper');
    const count = document.getElementById('node-count');

    if (!filter || !countWrapper || !count) return;

    const selectedValue = filter.value;

    if (selectedValue === 'all') {
        countWrapper.style.display = 'none';
        return;
    }

    countWrapper.style.display = 'inline';
    const rows = document.querySelectorAll('#nodes-table tbody tr');
    let visibleCount = 0;
    rows.forEach(row => {
        const isVisible = row.offsetParent !== null && row.style.display !== 'none';
        if (isVisible) visibleCount++;
    });
    count.textContent = visibleCount;
}

function runAfterRender(callback) {
    requestAnimationFrame(() => setTimeout(callback, 0));
}

window.addEventListener('load', () => {
    runAfterRender(updateNodeCount);

    // Add animation on load
    const computeTab = document.getElementById('compute');
    if (computeTab) {
        computeTab.classList.add('fade-in');
    }
});

document.getElementById('nodegroup-filter')?.addEventListener('change', () => {
    runAfterRender(updateNodeCount);
});
</script>
