<!-- Compute Tab -->
<div id="compute" class="tab-content">

    <!-- Styles for Node Group filter, count & animation -->
    <style>
    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--surface-color);
        border-top-left-radius: 8px;    
        border-top-right-radius: 8px;
    }

    .widget-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .resource-filters {
        display: flex;
        align-items: center;
    }

    .resource-filters select.form-select {
        padding: 8px 12px;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: var(--background-color);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s ease-in-out;
        min-width: 220px;
    }

    .resource-filters select.form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(60, 132, 244, 0.2);
    }

    .node-count-wrapper {
        font-weight: 500;
        font-size: 0.95rem;
        color: var(--text-muted);
        margin-left: 8px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.2s ease-in-out;
    }

    /* Pagination Styles */
    .pagination-controls {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--surface-color);
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-info {
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    </style>

    <!-- Nodes Section -->
    <div class="widget">
        <div class="widget-header">
            <h2>
                Nodes
                <span id="node-count-wrapper" class="node-count-wrapper" style="display: none;">
                    (<span id="node-count">0</span>)
                </span>
            </h2>
            <div class="resource-filters">
                <select id="nodegroup-filter" class="form-select">
                    <option value="all">All Node Groups</option>
                    {% for ng in cluster.nodegroups_data if not ng.is_karpenter_node %}
                    <option value="{{ ng.name }}">{{ ng.name }}</option>
                    {% endfor %}
                    <option value="karpenter">Karpenter/Auto-Mode</option>
                </select>
            </div>
        </div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table" id="nodes-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Instance Type</th>
                            <th>Node Group / Compute</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody id="nodes-table-body">
                        <!-- Nodes will be loaded dynamically with pagination -->
                    </tbody>
                </table>
            </div>
            <div id="nodes-pagination-controls" class="pagination-controls" style="display: none;">
                <button id="nodes-pagination-prev" class="action-btn">Previous</button>
                <span id="nodes-pagination-info" class="pagination-info"></span>
                <button id="nodes-pagination-next" class="action-btn">Next</button>
            </div>
            <div id="nodes-table-empty" class="no-data-message" style="display: none; padding: 4rem;">
                <p>No nodes found.</p>
                <p class="text-muted">This cluster does not have any nodes or node data is not available.</p>
            </div>
        </div>
    </div>

    <!-- Node Groups Section -->
    <div class="widget">
        <div class="widget-header"><h2>Node Groups</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Desired Size</th>
                            <th>AMI Release Version</th>
                            <th>K8s Version</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="nodegroups-table-body">
                        <!-- Node groups will be loaded dynamically with pagination -->
                    </tbody>
                </table>
            </div>
            <div id="nodegroups-pagination-controls" class="pagination-controls" style="display: none;">
                <button id="nodegroups-pagination-prev" class="action-btn">Previous</button>
                <span id="nodegroups-pagination-info" class="pagination-info"></span>
                <button id="nodegroups-pagination-next" class="action-btn">Next</button>
            </div>
            <div id="nodegroups-table-empty" class="no-data-message" style="display: none; padding: 4rem;">
                <p>No node groups found.</p>
                <p class="text-muted">This cluster does not have any managed node groups.</p>
            </div>
        </div>
    </div>

    <!-- Fargate Profiles Section -->
    <div class="widget">
        <div class="widget-header"><h2>Fargate Profiles</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Name</th><th>Status</th></tr></thead>
                    <tbody>
                        {% for profile in cluster.fargate_profiles %}
                        <tr>
                            <td>{{ profile.name }}</td>
                            <td><span class="status-badge status-{{ profile.status.lower() if profile.status else 'unknown' }}">{{ profile.status or 'Active' }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-muted" style="text-align: center; padding: 2rem;">
                                No Fargate profiles found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS for pagination and dynamic content -->
<script>
// Pagination state for nodes
let nodesPagination = {
    currentPage: 1,
    itemsPerPage: 10,
    filteredData: []
};

// Pagination state for node groups
let nodegroupsPagination = {
    currentPage: 1,
    itemsPerPage: 10,
    filteredData: []
};

// Raw data storage
let nodesData = [];
let nodegroupsData = [];

// Initialize compute tab data
function initializeComputeTab() {
    console.log('Initializing compute tab...');
    
    // Extract nodes data from template
    {% if cluster.workloads and 'nodes' in cluster.workloads and cluster.workloads['nodes'] %}
    nodesData = {{ cluster.workloads['nodes'] | tojson }};
    {% else %}
    nodesData = [];
    {% endif %}

    // Extract node groups data from template
    {% set managed_ngs = cluster.nodegroups_data | selectattr('is_karpenter_node', 'equalto', false) | list %}
    nodegroupsData = {{ managed_ngs | tojson }};

    console.log('Nodes data:', nodesData.length, 'items');
    console.log('Node groups data:', nodegroupsData.length, 'items');

    // Initialize both tables
    initializeNodesTable();
    initializeNodegroupsTable();
    
    // Set up filter event listener
    document.getElementById('nodegroup-filter')?.addEventListener('change', applyNodesFilter);
}

// Initialize nodes table
function initializeNodesTable() {
    applyNodesFilter();
    setupNodesPaginationEvents();
}

// Initialize node groups table
function initializeNodegroupsTable() {
    applyNodegroupsFilter();
    setupNodegroupsPaginationEvents();
}

// Apply nodes filter
function applyNodesFilter() {
    const filter = document.getElementById('nodegroup-filter');
    const selectedValue = filter ? filter.value : 'all';
    
    // Filter nodes based on nodegroup
    nodesPagination.filteredData = nodesData.filter(node => {
        const labels = node.metadata.labels || {};
        const nodegroup_name = labels['eks.amazonaws.com/nodegroup'];
        const is_karpenter_or_auto = 'karpenter.sh/provisioner-name' in labels || labels['eks.amazonaws.com/compute-type'] === 'ec2';
        const data_nodegroup_value = nodegroup_name || (is_karpenter_or_auto ? 'karpenter' : 'other');
        
        if (selectedValue === 'all') return true;
        if (selectedValue === 'karpenter') return data_nodegroup_value === 'karpenter';
        return data_nodegroup_value === selectedValue;
    });
    
    nodesPagination.currentPage = 1;
    renderNodesTable();
    updateNodeCount();
}

// Apply node groups filter (currently no filter, but structure for future)
function applyNodegroupsFilter() {
    nodegroupsPagination.filteredData = [...nodegroupsData];
    nodegroupsPagination.currentPage = 1;
    renderNodegroupsTable();
}

// Render nodes table
function renderNodesTable() {
    const { currentPage, itemsPerPage, filteredData } = nodesPagination;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = filteredData.slice(start, end);
    
    console.log('Rendering nodes table:', {
        currentPage,
        itemsPerPage,
        filteredDataLength: filteredData.length,
        pageDataLength: pageData.length,
        start,
        end
    });
    
    const tbody = document.getElementById('nodes-table-body');
    const tableContainer = document.querySelector('#nodes-table').closest('.table-container');
    const emptyMessage = document.getElementById('nodes-table-empty');
    const paginationControls = document.getElementById('nodes-pagination-controls');
    
    // Render table rows
    tbody.innerHTML = pageData.map(node => {
        const labels = node.metadata.labels || {};
        const nodegroup_name = labels['eks.amazonaws.com/nodegroup'];
        const is_karpenter_or_auto = 'karpenter.sh/provisioner-name' in labels || labels['eks.amazonaws.com/compute-type'] === 'ec2';
        const compute_display_name = nodegroup_name || (is_karpenter_or_auto ? 'Karpenter/Auto-Mode' : 'EC2 (Self-managed)');
        const node_status_obj = (node.status.conditions || []).find(c => c.type === 'Ready');
        const node_status = node_status_obj && node_status_obj.status === 'True' ? 'Ready' : 'NotReady';
        const created_date = node.metadata.creationTimestamp ? node.metadata.creationTimestamp.split('T')[0] : 'N/A';
        
        return `
            <tr>
                <td>${node.metadata.name}</td>
                <td><span class="status-badge status-${node_status.toLowerCase()}">${node_status}</span></td>
                <td>${labels['node.kubernetes.io/instance-type'] || 'N/A'}</td>
                <td>${compute_display_name}</td>
                <td>${created_date}</td>
            </tr>
        `;
    }).join('');
    
    // Update UI state
    const hasData = filteredData.length > 0;
    tableContainer.style.display = hasData ? 'block' : 'none';
    paginationControls.style.display = hasData ? 'flex' : 'none';
    emptyMessage.style.display = hasData ? 'none' : 'flex';
    
    if (hasData) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        document.getElementById('nodes-pagination-info').textContent = 
            `Page ${currentPage} of ${totalPages} (${filteredData.length} nodes)`;
        document.getElementById('nodes-pagination-prev').disabled = currentPage === 1;
        document.getElementById('nodes-pagination-next').disabled = currentPage === totalPages;
    }
}

// Render node groups table
function renderNodegroupsTable() {
    const { currentPage, itemsPerPage, filteredData } = nodegroupsPagination;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = filteredData.slice(start, end);
    
    const tbody = document.getElementById('nodegroups-table-body');
    const tableContainer = document.querySelector('#nodegroups-table-body').closest('.table-container');
    const emptyMessage = document.getElementById('nodegroups-table-empty');
    const paginationControls = document.getElementById('nodegroups-pagination-controls');
    
    // Render table rows
    tbody.innerHTML = pageData.map(ng => {
        const status = ng.status || 'unknown';
        const isUpToDate = ng.is_karpenter_node || ng.version === '{{ cluster.version }}';
        const actionButton = isUpToDate ? 
            '<span class="text-muted">Up to date</span>' : 
            `<button class="action-btn upgrade-btn" data-nodegroup-name="${ng.name}"><i data-feather="chevrons-up"></i> Upgrade Now</button>`;
        
        return `
            <tr>
                <td>${ng.name}</td>
                <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                <td>${ng.desired_size}</td>
                <td>${ng.release_version}</td>
                <td>${ng.version}</td>
                <td>${actionButton}</td>
            </tr>
        `;
    }).join('');
    
    // Update UI state
    const hasData = filteredData.length > 0;
    tableContainer.style.display = hasData ? 'block' : 'none';
    paginationControls.style.display = hasData ? 'flex' : 'none';
    emptyMessage.style.display = hasData ? 'none' : 'flex';
    
    if (hasData) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        document.getElementById('nodegroups-pagination-info').textContent = 
            `Page ${currentPage} of ${totalPages} (${filteredData.length} node groups)`;
        document.getElementById('nodegroups-pagination-prev').disabled = currentPage === 1;
        document.getElementById('nodegroups-pagination-next').disabled = currentPage === totalPages;
    }
    
    // Re-initialize feather icons for action buttons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

// Setup nodes pagination events
function setupNodesPaginationEvents() {
    console.log('Setting up nodes pagination events...');
    
    document.getElementById('nodes-pagination-prev')?.addEventListener('click', () => {
        console.log('Previous button clicked, current page:', nodesPagination.currentPage);
        if (nodesPagination.currentPage > 1) {
            nodesPagination.currentPage--;
            renderNodesTable();
        }
    });
    
    document.getElementById('nodes-pagination-next')?.addEventListener('click', () => {
        const totalPages = Math.ceil(nodesPagination.filteredData.length / nodesPagination.itemsPerPage);
        console.log('Next button clicked, current page:', nodesPagination.currentPage, 'total pages:', totalPages);
        if (nodesPagination.currentPage < totalPages) {
            nodesPagination.currentPage++;
            renderNodesTable();
        }
    });
}

// Setup node groups pagination events
function setupNodegroupsPaginationEvents() {
    document.getElementById('nodegroups-pagination-prev')?.addEventListener('click', () => {
        if (nodegroupsPagination.currentPage > 1) {
            nodegroupsPagination.currentPage--;
            renderNodegroupsTable();
        }
    });
    
    document.getElementById('nodegroups-pagination-next')?.addEventListener('click', () => {
        const totalPages = Math.ceil(nodegroupsPagination.filteredData.length / nodegroupsPagination.itemsPerPage);
        if (nodegroupsPagination.currentPage < totalPages) {
            nodegroupsPagination.currentPage++;
            renderNodegroupsTable();
        }
    });
}

// Update node count display
function updateNodeCount() {
    const countWrapper = document.getElementById('node-count-wrapper');
    const count = document.getElementById('node-count');

    if (!countWrapper || !count) return;

    // Always show the total count of all nodes, not filtered
    const totalCount = nodesData.length;
    count.textContent = totalCount;
    countWrapper.style.display = totalCount > 0 ? 'inline' : 'none';
    
    console.log(`Total nodes count updated to: ${totalCount}`);
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing compute tab...');
    initializeComputeTab();
    
    // Add animation on load
    const computeTab = document.getElementById('compute');
    if (computeTab) {
        computeTab.classList.add('fade-in');
    }
});

// Also try to initialize when the compute tab is opened
function initializeComputeTabOnTabSwitch() {
    console.log('Compute tab opened, checking initialization...');
    if (nodesData.length === 0 && nodegroupsData.length === 0) {
        console.log('Data not loaded yet, re-initializing...');
        initializeComputeTab();
    }
}

// Make the function globally available for tab switching
window.initializeComputeTabOnTabSwitch = initializeComputeTabOnTabSwitch;
</script>
